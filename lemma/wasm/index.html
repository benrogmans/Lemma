<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lemma WASM Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #333;
        }
        .section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f9f9f9;
        }
        textarea {
            width: 100%;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        input[type="text"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 3px;
            cursor: pointer;
            margin: 5px 5px 5px 0;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            margin-top: 15px;
            padding: 10px;
            background: white;
            border: 1px solid #28a745;
            border-radius: 3px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
        }
        .summary-table {
            margin-top: 15px;
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        .summary-table th {
            background: #f0f0f0;
            padding: 10px;
            text-align: left;
            border-bottom: 2px solid #ddd;
        }
        .summary-table td {
            padding: 8px 10px;
            border-bottom: 1px solid #eee;
        }
        .summary-table .rule-name {
            font-weight: 500;
            color: #007bff;
        }
        .summary-table .value {
            font-family: 'Courier New', monospace;
        }
        .summary-table .veto {
            color: #dc3545;
            font-style: italic;
        }
        .summary-table .missing {
            color: #856404;
            font-style: italic;
        }
        .error {
            border-color: #dc3545;
            background: #f8d7da;
        }
        .success {
            background: #d4edda;
        }
        #status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Lemma WASM Test Interface</h1>

    <div id="status">Loading WASM module...</div>

    <div class="section">
        <h2>1. Load Lemma Document</h2>
        <textarea id="lemmaCode" placeholder="Enter Lemma code...">doc pricing

fact quantity = 10
fact is_member = false

rule discount = 0%
  unless quantity >= 10 then 10%
  unless quantity >= 50 then 20%
  unless is_member then 15%

rule price = 100 usd - discount?</textarea>
        <button onclick="loadDocument()">Load Document</button>
        <div id="loadResult"></div>
    </div>

    <div class="section">
        <h2>2. Evaluate with Facts</h2>
        <label>Document Name:</label>
        <input type="text" id="docName" value="pricing" />

        <label>Facts (JSON object):</label>
        <textarea id="facts" placeholder='{"quantity": 25, "is_member": true}'>{"quantity": 25, "is_member": true}</textarea>

        <button onclick="evaluateDocument()">Evaluate</button>
        <div id="evalResultSummary"></div>
        <div id="evalResult"></div>
    </div>

    <div class="section">
        <h2>3. List Documents</h2>
        <button onclick="listDocuments()">List All Documents</button>
        <div id="listResult"></div>
    </div>

    <script type="module">
        import init, { WasmEngine } from '../pkg/lemma.js';

        let engine = null;

        async function initializeWasm() {
            try {
                await init();
                engine = new WasmEngine();

                const status = document.getElementById('status');
                status.textContent = '✓ WASM module loaded successfully';
                status.className = 'success';

                // Make functions available globally
                window.engine = engine;
                window.loadDocument = loadDocument;
                window.evaluateDocument = evaluateDocument;
                window.listDocuments = listDocuments;
            } catch (error) {
                const status = document.getElementById('status');
                status.textContent = '✗ Failed to load WASM: ' + error.message;
                status.className = 'error';
            }
        }

        function loadDocument() {
            const code = document.getElementById('lemmaCode').value;
            const resultDiv = document.getElementById('loadResult');

            try {
                const result = JSON.parse(engine.addLemmaCode(code, 'test.lemma'));

                if (result.success) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '✓ ' + (result.message || 'Document added successfully');
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '✗ Error: ' + result.error;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '✗ Exception: ' + error.message;
            }
        }

        function evaluateDocument() {
            const docName = document.getElementById('docName').value;
            const factsText = document.getElementById('facts').value;
            const summaryDiv = document.getElementById('evalResultSummary');
            const resultDiv = document.getElementById('evalResult');

            try {
                // Parse and validate the facts JSON
                let factsObj = {};
                if (factsText.trim()) {
                    factsObj = JSON.parse(factsText);
                }

                const result = JSON.parse(engine.evaluate(docName, JSON.stringify(factsObj)));

                if (result.success) {
                    // Show warnings if any
                    if (result.warnings && result.warnings.length > 0) {
                        summaryDiv.innerHTML = `<div class="result" style="background: #fff3cd; border-color: #ffc107;">
                            ⚠️ Warnings: ${result.warnings.join(', ')}
                        </div>`;
                    } else {
                        summaryDiv.innerHTML = '';
                    }

                    // Create summary table
                    let summaryHTML = '<table class="summary-table">';
                    summaryHTML += '<thead><tr><th>Rule</th><th>Result</th><th>Details</th></tr></thead>';
                    summaryHTML += '<tbody>';

                    for (const [ruleName, ruleData] of Object.entries(result.rules)) {
                        summaryHTML += '<tr>';
                        summaryHTML += `<td class="rule-name">${ruleName}</td>`;

                        if (ruleData.veto) {
                            summaryHTML += `<td class="veto">Vetoed</td>`;
                            summaryHTML += `<td class="veto">${ruleData.veto}</td>`;
                        } else if (ruleData.missing_facts && ruleData.missing_facts.length > 0) {
                            summaryHTML += `<td class="missing">-</td>`;
                            summaryHTML += `<td class="missing">Missing: ${ruleData.missing_facts.join(', ')}</td>`;
                        } else {
                            const resultValue = ruleData.result ? ruleData.result.value : 'null';
                            summaryHTML += `<td class="value">${resultValue}</td>`;
                            summaryHTML += `<td style="color: #28a745">✓ Computed</td>`;
                        }

                        summaryHTML += '</tr>';
                    }

                    summaryHTML += '</tbody></table>';
                    summaryDiv.innerHTML += summaryHTML;

                    // Show full JSON in details
                    resultDiv.className = 'result success';
                    resultDiv.textContent = '✓ Full Response (JSON):\n\n' +
                        JSON.stringify(result, null, 2);
                } else {
                    summaryDiv.innerHTML = '';
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '✗ Error: ' + result.error;
                }
            } catch (error) {
                summaryDiv.innerHTML = '';
                resultDiv.className = 'result error';
                resultDiv.textContent = '✗ Exception: ' + error.message;
            }
        }

        function listDocuments() {
            const resultDiv = document.getElementById('listResult');

            try {
                const result = JSON.parse(engine.listDocuments());

                if (result.success) {
                    resultDiv.className = 'result success';
                    const docs = result.documents;
                    if (docs.length > 0) {
                        resultDiv.textContent = '✓ Loaded Documents:\n' +
                            docs.map(d => '  • ' + d).join('\n');
                    } else {
                        resultDiv.textContent = '✓ No documents loaded yet';
                    }
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = '✗ Error: ' + result.error;
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = '✗ Exception: ' + error.message;
            }
        }

        // Initialize on page load
        initializeWasm();
    </script>
</body>
</html>
